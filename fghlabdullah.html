<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Crash-Proof Side Scroller</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000;}
canvas{display:block;}
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener("resize", resize);
resize();

// ===== Player =====
const player = { x:100, y:0, w:40, h:50, dx:0, dy:0, speed:4, jump:12,
                 grounded:false, canDoubleJump:true, dashCooldown:0, dashing:false, dashTime:0 };

// ===== Controls =====
const keys = {};
window.addEventListener("keydown", e=>keys[e.key.toLowerCase()]=true);
window.addEventListener("keyup", e=>keys[e.key.toLowerCase()]=false);

// ===== World =====
const CHUNK = 800;
let chunks = []; // Each chunk: {index, ground, platforms}
const biomes = [
  {bg:"#87ceeb", ground:"#2ecc71"},
  {bg:"#f6d365", ground:"#27ae60"},
  {bg:"#c7ecee", ground:"#16a085"},
  {bg:"#ff6b6b", ground:"#c0392b"}
];

function getGroundY(){ return canvas.height-50; }
function getBiome(idx){ return biomes[idx%biomes.length]; }

function generateChunk(index){
  if(chunks.find(c=>c.index===index)) return;
  const biome = getBiome(index);
  const baseX = index*CHUNK;
  const chunk = {index, ground:{x:baseX, y:getGroundY(), w:CHUNK, h:50, color:biome.ground}, platforms:[]};
  // 1â€“2 simple platforms
  const numPlatforms = Math.floor(Math.random()*2)+1;
  for(let i=0;i<numPlatforms;i++){
    chunk.platforms.push({x:baseX+100+Math.random()*600, y:getGroundY()-50-Math.random()*60, w:80, h:20, color:biome.ground});
  }
  chunks.push(chunk);
}

function generateChunksAroundPlayer(){
  const playerChunk = Math.floor(player.x/CHUNK);
  for(let i=playerChunk-1;i<=playerChunk+2;i++) generateChunk(i);
  chunks = chunks.filter(c=>c.index>=playerChunk-1 && c.index<=playerChunk+2); // remove old chunks
}

// ===== Update =====
function update(){
  // Move
  player.dx = 0;
  if(keys["a"]) player.dx=-player.speed;
  if(keys["d"]) player.dx=player.speed;

  // Jump
  if((keys["w"]||keys[" "]) && player.grounded){ player.dy=-player.jump; player.grounded=false; player.canDoubleJump=true; }
  else if((keys["w"]||keys[" "]) && !player.grounded && player.canDoubleJump){ player.dy=-player.jump; player.canDoubleJump=false; }

  // Dash
  if(keys["shift"] && player.dashCooldown<=0 && !player.dashing){ player.dashing=true; player.dashTime=10; player.dashCooldown=30; }
  if(player.dashing){ player.dx=15; player.dashTime--; if(player.dashTime<=0) player.dashing=false; }
  if(player.dashCooldown>0) player.dashCooldown--;

  // Gravity
  player.dy+=0.6;
  player.x+=player.dx;
  player.y+=player.dy;

  generateChunksAroundPlayer();

  // Collisions
  player.grounded=false;
  chunks.forEach(c=>{
    const objs = [c.ground].concat(c.platforms);
    objs.forEach(p=>{
      if(player.x+player.w>p.x && player.x<p.x+p.w && player.y+player.h>=p.y && player.y+player.h<=p.y+10){
        player.y=p.y-player.h; player.dy=0; player.grounded=true; player.canDoubleJump=true;
      }
    });
  });

  // Keep player above ground
  if(player.y>canvas.height) reset();
}

// ===== Draw =====
function draw(){
  const biome = getBiome(Math.floor(player.x/CHUNK));
  ctx.fillStyle=biome.bg; ctx.fillRect(0,0,canvas.width,canvas.height);

  const cameraX = Math.max(0,player.x-canvas.width/3);
  ctx.save(); ctx.translate(-cameraX,0);

  chunks.forEach(c=>{
    ctx.fillStyle=c.ground.color; ctx.fillRect(c.ground.x,c.ground.y,c.ground.w,c.ground.h);
    c.platforms.forEach(p=>{ ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,p.w,p.h); });
  });

  ctx.fillStyle="#ff4757"; ctx.fillRect(player.x,player.y,player.w,player.h);

  ctx.restore();

  ctx.fillStyle="#fff"; ctx.font="14px monospace";
  ctx.fillText(`Dash Cooldown: ${player.dashCooldown}`,20,25);
}

// ===== Reset =====
function reset(){ player.x=100; player.y=0; player.dy=0; player.grounded=false; player.canDoubleJump=true; chunks=[]; }

// ===== Loop =====
(function loop(){ update(); draw(); requestAnimationFrame(loop); })();
</script>
</body>
</html>
