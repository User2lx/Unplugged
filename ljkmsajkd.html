<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flappy Bird Slow Motion Fixed</title>
<style>
body {margin:0; display:flex; justify-content:center; align-items:center; height:100vh; background:#4ec0ca; font-family:sans-serif;}
canvas {border:2px solid #333; display:block;}
</style>
</head>
<body>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Game state
let frame=0, score=0, highScore=Number(localStorage.getItem('flappyHighScore'))||0;
let gameOver=false, inMenu=true;
let animationFrameId;

// Bird
let bird = {
  x:80, y:300, width:30, height:30,
  gravity:0.2, velocity:0, jump:-5, color:'#FFD93D',
  rotation:0, wingOffset:0, wingDir:1, bounce:0, bounceDir:1
};

// Pipes
let pipes=[], pipeWidth=60, pipeGap=150, pipeSpeed=1, pipeSpawnRate=180;

// Clouds
let clouds=[
  {x:50,y:80,width:60,height:30,speed:0.2,alpha:1,fadeDir:-0.003},
  {x:200,y:120,width:80,height:40,speed:0.15,alpha:1,fadeDir:0.002},
  {x:350,y:60,width:50,height:25,speed:0.18,alpha:1,fadeDir:-0.0025}
];

// Ground
const groundHeight=80; let groundX=0, groundSpeed=0.2;

// Controls
document.addEventListener('keydown', e => { if(e.code==='Space') jump(); });
canvas.addEventListener('click', jump);

function jump(){
  if(inMenu){
    inMenu = false;
    restart();
    return;
  }
  if(gameOver){
    inMenu = true; // Return to menu after death
    return;
  }
  // Normal jump during gameplay
  bird.velocity = bird.jump;
  bird.rotation = -Math.PI/6;
}

// Helpers
function roundRect(x,y,w,h,r,c){ ctx.fillStyle=c; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); ctx.fill(); }

function checkCollision(pipe){ 
  return (bird.x<pipe.x+pipeWidth && bird.x+bird.width>pipe.x && (bird.y<pipe.top || bird.y+bird.height>pipe.bottom)) || bird.y+bird.height>canvas.height-groundHeight || bird.y<0; 
}

function createPipe(){ 
  const topH=Math.random()*(canvas.height-pipeGap-groundHeight-120)+60; 
  pipes.push({x:canvas.width,top:topH,bottom:topH+pipeGap,color:'#06d6a0'}); 
}

// Draw
function draw(){
  const sky=ctx.createLinearGradient(0,0,0,canvas.height); 
  sky.addColorStop(0,'#4ec0ca'); sky.addColorStop(1,'#3aa5b0'); 
  ctx.fillStyle=sky; ctx.fillRect(0,0,canvas.width,canvas.height);

  clouds.forEach(c=>{ctx.globalAlpha=c.alpha; roundRect(c.x,c.y,c.width,c.height,15,'#fff'); ctx.globalAlpha=1;});

  if(inMenu){
    ctx.fillStyle='#FFD93D'; ctx.font='48px Arial'; ctx.fillText('FLAPPY BIRD',40,200);
    ctx.fillStyle='#06d6a0'; ctx.font='28px Arial'; ctx.fillText('Click/Space to Play',40,300);
    ctx.fillText(`High Score: ${highScore}`,40,350);

    ctx.save(); ctx.translate(bird.x+bird.width/2,bird.y+bird.height/2+bird.bounce); ctx.rotate(bird.rotation);
    roundRect(-bird.width/2,-bird.height/2,bird.width,bird.height,6,bird.color);
    ctx.fillStyle='#f4c542'; ctx.fillRect(-bird.width/2-5,bird.wingOffset-5,10,10); ctx.fillRect(bird.width/2-5,-bird.wingOffset-5,10,10);
    ctx.restore(); 
    return;
  }

  ctx.save(); ctx.translate(bird.x+bird.width/2,bird.y+bird.height/2+bird.bounce); ctx.rotate(bird.rotation);
  roundRect(-bird.width/2,-bird.height/2,bird.width,bird.height,6,bird.color);
  ctx.fillStyle='#f4c542'; ctx.fillRect(-bird.width/2-5,bird.wingOffset-5,10,10); ctx.fillRect(bird.width/2-5,-bird.wingOffset-5,10,10);
  ctx.restore();

  pipes.forEach(pipe=>{
    roundRect(pipe.x,0,pipeWidth,pipe.top,10,pipe.color); 
    roundRect(pipe.x,pipe.bottom,pipeWidth,canvas.height-pipe.bottom-groundHeight,10,pipe.color);
    ctx.fillStyle='#34c9a3'; ctx.fillRect(pipe.x,0,pipeWidth,10); 
    ctx.fillRect(pipe.x,pipe.bottom,pipeWidth,10);
  });

  groundX-=groundSpeed; if(groundX<=-canvas.width) groundX=0;
  ctx.fillStyle='#8d5524'; ctx.fillRect(groundX,canvas.height-groundHeight,canvas.width,groundHeight); 
  ctx.fillRect(groundX+canvas.width,canvas.height-groundHeight,canvas.width,groundHeight);
  for(let i=0;i<20;i++){ctx.fillStyle='#7a4320'; ctx.fillRect((i*20+groundX)%canvas.width,canvas.height-20,10,10);}

  ctx.fillStyle='#fff'; ctx.font='28px Arial'; ctx.fillText(`Score: ${score}`,10,35); 
  ctx.fillText(`High: ${highScore}`,10,70);

  if(gameOver){ ctx.fillStyle='#ff4b5c'; ctx.font='48px Arial'; ctx.fillText('Game Over',60,canvas.height/2); ctx.font='24px Arial'; ctx.fillText('Click/Space for Menu',50,canvas.height/2+50);}
}

// Update
function update(){
  frame++;

  if(inMenu){
    bird.wingOffset+=0.3*bird.wingDir; if(bird.wingOffset>6||bird.wingOffset<-6) bird.wingDir*=-1;
    bird.bounce+=0.1*bird.bounceDir; if(bird.bounce>3||bird.bounce<-3) bird.bounceDir*=-1;
    clouds.forEach(c=>{c.x-=c.speed; if(c.x+c.width<0)c.x=canvas.width; c.alpha+=c.fadeDir; if(c.alpha>1||c.alpha<0.4)c.fadeDir*=-1;});
    draw(); animationFrameId = requestAnimationFrame(update); return;
  }

  if(!gameOver){
    bird.velocity+=bird.gravity; 
    bird.y+=bird.velocity; 
    bird.rotation += (Math.min(Math.PI/4,bird.velocity/10)-bird.rotation)*0.1;
    bird.wingOffset+=0.3*bird.wingDir; if(bird.wingOffset>6||bird.wingOffset<-6) bird.wingDir*=-1;
    bird.bounce+=0.1*bird.bounceDir; if(bird.bounce>2||bird.bounce<-2) bird.bounceDir*=-1;

    clouds.forEach(c=>{c.x-=c.speed; if(c.x+c.width<0)c.x=canvas.width; c.alpha+=c.fadeDir; if(c.alpha>1||c.alpha<0.4)c.fadeDir*=-1;});

    if(frame%pipeSpawnRate===0) createPipe();
    pipes.forEach((p,i)=>{
      p.x-=pipeSpeed; 
      if(checkCollision(p)) gameOver=true; 
      if(p.x+pipeWidth===bird.x) score++; 
      if(p.x+pipeWidth<0) pipes.splice(i,1);
    });
  }

  if(score>highScore){ highScore=score; localStorage.setItem('flappyHighScore',highScore);}
  draw();
  animationFrameId = requestAnimationFrame(update);
}

// Restart
function restart(){
  bird.y = 300;
  bird.velocity = 0;
  bird.rotation = 0;
  bird.wingOffset = 0;
  bird.wingDir = 1;
  bird.bounce = 0;
  bird.bounceDir = 1;

  pipes = [];
  score = 0;
  frame = 0;
  gameOver = false;
  groundX = 0;

  clouds.forEach(c => { c.x = Math.random() * canvas.width; c.alpha = 1; });

  if(animationFrameId) cancelAnimationFrame(animationFrameId);

  update();
}

update();
</script>
</body>
</html>
