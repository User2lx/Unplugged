<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Infinite Side Scroller</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #000;
  }
  canvas {
    display: block;
  }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
// ===== CANVAS SETUP =====
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// ===== CONSTANTS =====
const gravity = 0.6;
const CHUNK = 800;

// ===== BIOMES =====
const biomes = [
  { bg: "#87ceeb", ground: "#2f3542", enemySpeed: 1 },
  { bg: "#f6d365", ground: "#b97745", enemySpeed: 1.2 },
  { bg: "#c7ecee", ground: "#535c68", enemySpeed: 1 },
  { bg: "#ff6b6b", ground: "#6D214F", enemySpeed: 1.4 }
];

function getBiome(chunk) {
  return biomes[Math.floor(chunk / 5) % biomes.length];
}

// ===== INPUT =====
const keys = {};
addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// ===== PLAYER =====
const player = {
  x: 100, y: 0, w: 40, h: 50,
  dx: 0, dy: 0,
  speed: 4,
  jump: 12,
  grounded: false,
  facing: 1,
  health: 5,
  maxHealth: 5,
  attacking: false,
  atk: 0,
  atkDuration: 10
};

// ===== WORLD STATE =====
let cameraX = 0;
let groundChunks = [];
let platforms = [];
let enemies = [];
let upgrades = [];

// ===== UTILS =====
function hit(a,b){
  return a.x < b.x+b.w && a.x+a.w > b.x &&
         a.y < b.y+b.h && a.y+a.h > b.y;
}

// ===== WORLD GEN =====
function generateChunks() {
  const playerChunk = Math.floor(player.x / CHUNK);
  for (let i = playerChunk - 1; i <= playerChunk + 2; i++) {
    if (!groundChunks.find(c => c.index === i)) createChunk(i);
  }
}

function createChunk(index) {
  const baseX = index * CHUNK;
  const biome = getBiome(index);
  const difficulty = Math.floor(index / 3);

  // ground
  groundChunks.push({
    index,
    x: baseX,
    y: canvas.height - 50,
    w: CHUNK,
    h: 50,
    color: biome.ground
  });

  // platforms
  for (let i = 0; i < 2; i++) {
    platforms.push({
      x: baseX + 100 + Math.random() * 500,
      y: canvas.height - 200 - Math.random() * 150,
      w: 80 + Math.random() * 80,
      h: 20,
      color: biome.ground
    });
  }

  // enemies
  if (Math.random() < 0.6) {
    enemies.push({
      x: baseX + 400,
      y: canvas.height - 90,
      w: 40, h: 40,
      dx: (Math.random()<0.5?-1:1) *
          biome.enemySpeed *
          (1 + difficulty * 0.1),
      hp: 1 + Math.floor(difficulty / 4)
    });
  }

  // upgrades
  if (Math.random() < 0.4) {
    upgrades.push({
      x: baseX + 300 + Math.random() * 200,
      y: canvas.height - 260,
      w: 25,
      h: 25
    });
  }
}

// ===== UPGRADES =====
function applyUpgrade() {
  const roll = Math.floor(Math.random() * 4);
  if (roll === 0) {
    player.maxHealth++;
    player.health = player.maxHealth;
  } else if (roll === 1) {
    player.speed += 0.5;
  } else if (roll === 2) {
    player.jump += 2;
  } else {
    player.atkDuration += 5;
  }
}

// ===== UPDATE =====
function update() {
  player.dx = 0;
  if (keys["a"]) { player.dx = -player.speed; player.facing = -1; }
  if (keys["d"]) { player.dx =  player.speed; player.facing =  1; }

  if ((keys["w"] || keys[" "]) && player.grounded) {
    player.dy = -player.jump;
    player.grounded = false;
  }

  if (keys["j"] && !player.attacking) {
    player.attacking = true;
    player.atk = player.atkDuration;
  }

  player.dy += gravity;
  player.x += player.dx;
  player.y += player.dy;

  cameraX = Math.max(0, player.x - canvas.width / 3);

  generateChunks();

  player.grounded = false;
  groundChunks.forEach(g => {
    if (hit(player, g) && player.dy > 0) {
      player.y = g.y - player.h;
      player.dy = 0;
      player.grounded = true;
    }
  });

  platforms.forEach(p => {
    if (hit(player, p) && player.dy > 0) {
      player.y = p.y - player.h;
      player.dy = 0;
      player.grounded = true;
    }
  });

  if (player.attacking && --player.atk <= 0)
    player.attacking = false;

  enemies.forEach(e => {
    e.x += e.dx;

    if (hit(player, e)) {
      player.health--;
      player.x -= 20 * Math.sign(e.dx);
      if (player.health <= 0) reset();
    }

    if (player.attacking) {
      const atk = {
        x: player.x + (player.facing === 1 ? player.w : -30),
        y: player.y + 10,
        w: 30, h: 30
      };
      if (hit(atk, e)) e.hp--;
    }
  });

  upgrades.forEach((u, i) => {
    if (hit(player, u)) {
      applyUpgrade();
      upgrades.splice(i, 1);
    }
  });

  const minChunk = Math.floor(player.x / CHUNK) - 2;
  groundChunks = groundChunks.filter(c => c.index >= minChunk);
  platforms = platforms.filter(p => p.x > minChunk * CHUNK);
  enemies = enemies.filter(e => e.hp > 0 && e.x > minChunk * CHUNK);
  upgrades = upgrades.filter(u => u.x > minChunk * CHUNK);
}

// ===== DRAW =====
function draw() {
  const biome = getBiome(Math.floor(player.x / CHUNK));
  canvas.style.background = biome.bg;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(-cameraX,0);

  groundChunks.forEach(g => {
    ctx.fillStyle = g.color;
    ctx.fillRect(g.x,g.y,g.w,g.h);
  });

  platforms.forEach(p => {
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x,p.y,p.w,p.h);
  });

  ctx.fillStyle = "#9b59b6";
  upgrades.forEach(u => ctx.fillRect(u.x,u.y,u.w,u.h));

  ctx.fillStyle = "#ff4757";
  ctx.fillRect(player.x,player.y,player.w,player.h);

  if (player.attacking) {
    ctx.fillStyle = "#ffa502";
    ctx.fillRect(
      player.x + (player.facing===1?player.w:-30),
      player.y+10,30,30
    );
  }

  ctx.fillStyle = "#2ed573";
  enemies.forEach(e => ctx.fillRect(e.x,e.y,e.w,e.h));

  ctx.restore();

  ctx.fillStyle = "#fff";
  ctx.font = "14px monospace";
  ctx.fillText(`HP ${player.health}/${player.maxHealth}`, 20, 25);
  ctx.fillText(`Speed ${player.speed.toFixed(1)}`, 20, 45);
  ctx.fillText(`Jump ${player.jump}`, 20, 65);
  ctx.fillText(`Atk ${player.atkDuration}`, 20, 85);
}

// ===== RESET =====
function reset() {
  player.x = 100;
  player.y = 0;
  player.health = player.maxHealth = 5;
  player.speed = 4;
  player.jump = 12;
  player.atkDuration = 10;
  groundChunks = [];
  platforms = [];
  enemies = [];
  upgrades = [];
}

// ===== LOOP =====
(function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
})();
</script>

</body>
</html>
