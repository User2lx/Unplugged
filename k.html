// -------------- Canvas -----------------
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;
const hud=document.getElementById('hud');

// -------------- Assets -----------------
const weaponSprites={
  pistol: new Image(),
  shotgun: new Image()
};
weaponSprites.pistol.src='assets/weapons/pistol.png';
weaponSprites.shotgun.src='assets/weapons/shotgun.png';

const enemySprites={
  imp: new Image(),
  demon: new Image()
};
enemySprites.imp.src='assets/enemies/imp.png';
enemySprites.demon.src='assets/enemies/demon.png';

// Sounds
const soundShoot=new Audio('assets/sounds/gunshot.wav');
const soundPickup=new Audio('assets/sounds/pickup.wav');
const soundHit=new Audio('assets/sounds/hit.wav');
const bgMusic=new Audio('assets/music/doom_theme.mp3'); bgMusic.loop=true; bgMusic.volume=0.3; bgMusic.play();

// -------------- Map -----------------
const levels=[/*...same as before, 2D array maps...*/];
let currentLevel=0;
let map=levels[currentLevel];

// -------------- Textures -----------------
const textures={1:'#888',2:'#55f',3:'#f00',4:'#ff0',5:'#0ff'};

// -------------- Player -----------------
let player={x:3.5,y:3.5,dir:Math.PI/4,fov:Math.PI/3,health:100,ammo:50,keys:0,speed:0.08,rotSpeed:0.04,weapon:'pistol'};

// -------------- Enemies -----------------
let enemies=[{x:6.5,y:2.5,health:30,type:'imp'},{x:2.5,y:4.5,health:30,type:'imp'}];

// -------------- Bullets -----------------
let bullets=[];

// -------------- Controls -----------------
const keysPressed={};
document.addEventListener('keydown',e=>keysPressed[e.key]=true);
document.addEventListener('keyup',e=>keysPressed[e.key]=false);

document.addEventListener('click',()=>{
  if(player.ammo>0){
    player.ammo--;
    bullets.push({x:player.x,y:player.y,dx:Math.cos(player.dir)*0.2,dy:Math.sin(player.dir)*0.2});
    weaponFireAnim=5; soundShoot.currentTime=0; soundShoot.play();
  }
});

// -------------- Raycasting -----------------
function castRays(){/* same as before, with shading */}

// -------------- Enemy AI -----------------
function moveEnemies(){/* same as before */}

// -------------- Bullets -----------------
function updateBullets(){/* same as before, with sprite collisions */}

// -------------- Draw Enemies -----------------
function drawEnemies(){
  enemies.forEach(e=>{
    const dx=e.x-player.x; const dy=e.y-player.y;
    const angle=Math.atan2(dy,dx)-player.dir;
    if(Math.abs(angle)<player.fov/2){
      const dist=Math.sqrt(dx*dx+dy*dy);
      const size=canvas.height/dist/2;
      const screenX=(angle/(player.fov/2))*(canvas.width/2)+canvas.width/2;
      const sprite=enemySprites[e.type];
      ctx.drawImage(sprite,screenX-size/2,canvas.height/2-size/2,size,size);
    }
  });
}

// -------------- Draw Weapon -----------------
let weaponFireAnim=0;
function drawWeapon(){
  const sprite=weaponSprites[player.weapon];
  const bob=Math.sin(Date.now()/100)*5;
  const fireOffset=weaponFireAnim*3;
  ctx.drawImage(sprite,canvas.width/2-sprite.width/2,canvas.height-sprite.height+fireOffset+bob);
  if(weaponFireAnim>0) weaponFireAnim--;
}

// -------------- Mini-map -----------------
function drawMinimap(){/* enhanced with walls, enemies, keys, pickups */}

// -------------- Player Movement -----------------
function handleMovement(){/* same as before */}

// -------------- Level Progression -----------------
function checkLevelUp(){/* fade transition, reload map, respawn enemies */}

// -------------- Game Loop -----------------
function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  handleMovement(); castRays(); moveEnemies(); updateBullets(); drawEnemies(); drawWeapon(); drawMinimap(); checkLevelUp();
  hud.innerText=`Health:${Math.floor(player.health)} | Ammo:${player.ammo} | Keys:${player.keys}`;
  requestAnimationFrame(gameLoop);
}
gameLoop();
