<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Infinite Side Scroller</title>
<style>
  body { margin: 0; background: #111; overflow: hidden; }
  canvas { display: block; margin: auto; background: #87ceeb; }
</style>
</head>
<body>
<canvas id="game" width="800" height="450"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const gravity = 0.6;
const CHUNK = 800;

let cameraX = 0;
let platforms = [];
let enemies = [];

// INPUT
const keys = {};
addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// PLAYER
const player = {
  x: 100, y: 0, w: 40, h: 50,
  dx: 0, dy: 0,
  speed: 4, jump: 12,
  grounded: false,
  facing: 1,
  health: 5,
  attacking: false,
  atk: 0
};

// COLLISION
function hit(a,b){
  return a.x < b.x+b.w && a.x+a.w > b.x &&
         a.y < b.y+b.h && a.y+a.h > b.y;
}

// GENERATE WORLD AHEAD
function generateWorld() {
  const lastX = platforms.length
    ? platforms[platforms.length - 1].x
    : -CHUNK;

  while (lastPlatformX() < cameraX + canvas.width * 2) {
    const baseX = lastPlatformX() + CHUNK;

    // ground
    platforms.push({
      x: baseX,
      y: 400,
      w: CHUNK,
      h: 50
    });

    // floating platforms
    for (let i = 0; i < 2; i++) {
      platforms.push({
        x: baseX + 100 + Math.random() * 500,
        y: 250 + Math.random() * 100,
        w: 80 + Math.random() * 80,
        h: 20
      });
    }

    // enemy
    if (Math.random() < 0.7) {
      enemies.push({
        x: baseX + 400,
        y: 360,
        w: 40, h: 40,
        dx: Math.random() < 0.5 ? -1.2 : 1.2,
        hp: 1
      });
    }
  }
}

function lastPlatformX() {
  let max = -CHUNK;
  platforms.forEach(p => {
    if (p.y === 400 && p.x > max) max = p.x;
  });
  return max;
}

// UPDATE
function update() {
  // INPUT
  player.dx = 0;
  if (keys["a"]) { player.dx = -player.speed; player.facing = -1; }
  if (keys["d"]) { player.dx =  player.speed; player.facing =  1; }

  if ((keys["w"] || keys[" "]) && player.grounded) {
    player.dy = -player.jump;
    player.grounded = false;
  }

  if (keys["j"] && !player.attacking) {
    player.attacking = true;
    player.atk = 10;
  }

  // PHYSICS
  player.dy += gravity;
  player.x += player.dx;
  player.y += player.dy;

  // CAMERA
  cameraX = Math.max(0, player.x - canvas.width / 3);

  generateWorld();

  // PLATFORM COLLISION
  player.grounded = false;
  platforms.forEach(p => {
    if (hit(player, p) && player.dy > 0) {
      player.y = p.y - player.h;
      player.dy = 0;
      player.grounded = true;
    }
  });

  // ATTACK TIMER
  if (player.attacking && --player.atk <= 0)
    player.attacking = false;

  // ENEMIES
  enemies.forEach(e => {
    e.x += e.dx;

    if (hit(player, e)) {
      player.health--;
      player.x -= 20 * e.dx;
      if (player.health <= 0) reset();
    }

    if (player.attacking) {
      const atkBox = {
        x: player.x + (player.facing === 1 ? player.w : -30),
        y: player.y + 10,
        w: 30, h: 30
      };
      if (hit(atkBox, e)) e.hp--;
    }
  });

  // CLEANUP
  platforms = platforms.filter(p => p.x > cameraX - 400);
  enemies = enemies.filter(e => e.hp > 0 && e.x > cameraX - 400);
}

// DRAW
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(-cameraX, 0);

  // PLATFORMS
  ctx.fillStyle = "#2f3542";
  platforms.forEach(p =>
    ctx.fillRect(p.x, p.y, p.w, p.h)
  );

  // PLAYER
  ctx.fillStyle = "#ff4757";
  ctx.fillRect(player.x, player.y, player.w, player.h);

  // ATTACK
  if (player.attacking) {
    ctx.fillStyle = "#ffa502";
    ctx.fillRect(
      player.x + (player.facing === 1 ? player.w : -30),
      player.y + 10,
      30, 30
    );
  }

  // ENEMIES
  ctx.fillStyle = "#2ed573";
  enemies.forEach(e =>
    ctx.fillRect(e.x, e.y, e.w, e.h)
  );

  ctx.restore();

  // UI
  ctx.fillStyle = "#fff";
  ctx.font = "16px monospace";
  ctx.fillText("Health: " + player.health, 20, 30);
  ctx.fillText("Distance: " + Math.floor(player.x), 20, 50);
}

// RESET
function reset() {
  player.x = 100;
  player.y = 0;
  player.health = 5;
  platforms = [];
  enemies = [];
}

// LOOP
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
