<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Side Scroller with Dash & Double Jump</title>
<style>
  html, body { margin:0; padding:0; overflow:hidden; background:#000; }
  canvas { display:block; }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
// ===== Canvas =====
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
window.addEventListener("resize", resize);
resize();

// ===== Player =====
const player = {
  x:100, y:0, w:40, h:50,
  dx:0, dy:0,
  speed:4, jump:12,
  grounded:false, facing:1,
  attacking:false, atk:0, atkDuration:10,
  health:5, maxHealth:5,
  canDoubleJump:true, dashCooldown:0, dashing:false, dashTime:0
};

// ===== Controls =====
const keys = {};
window.addEventListener("keydown", e=>keys[e.key.toLowerCase()]=true);
window.addEventListener("keyup", e=>keys[e.key.toLowerCase()]=false);

// ===== World =====
const CHUNK = 800;
let groundChunks=[], platforms=[], enemies=[], upgrades=[];
function getGroundY(){ return canvas.height-50; }

// ===== World Generation =====
function createChunk(index){
  const baseX = index*CHUNK;
  groundChunks.push({x:baseX, y:getGroundY(), w:CHUNK, h:50});
  for(let i=0;i<2;i++){
    platforms.push({x:baseX+100+Math.random()*500, y:getGroundY()-150-Math.random()*100, w:80+Math.random()*80, h:20});
  }
  if(Math.random()<0.6){
    enemies.push({x:baseX+300+Math.random()*300, y:getGroundY()-40, w:40, h:40, dx:(Math.random()<0.5?-1:1), hp:1});
  }
  if(Math.random()<0.3){
    upgrades.push({x:baseX+300+Math.random()*200, y:getGroundY()-220, w:25, h:25});
  }
}

function generateChunks(){
  const playerChunk = Math.floor(player.x/CHUNK);
  for(let i=playerChunk-1;i<=playerChunk+2;i++){
    if(!groundChunks.find(c=>c.x===i*CHUNK)) createChunk(i);
  }
}

// ===== Upgrades =====
function applyUpgrade(){
  const roll=Math.floor(Math.random()*4);
  if(roll===0){ player.maxHealth++; player.health=player.maxHealth; }
  else if(roll===1){ player.speed+=0.5; }
  else if(roll===2){ player.jump+=2; }
  else{ player.atkDuration+=5; }
}

// ===== Update =====
function update(){
  // Horizontal movement
  player.dx = 0;
  if(keys["a"]) player.dx=-player.speed;
  if(keys["d"]) player.dx=player.speed;

  // Jump
  if((keys["w"]||keys[" "]) && player.grounded){ player.dy=-player.jump; player.grounded=false; player.canDoubleJump=true; }
  else if((keys["w"]||keys[" "]) && !player.grounded && player.canDoubleJump){ player.dy=-player.jump; player.canDoubleJump=false; }

  // Dash (Shift)
  if(keys["shift"] && player.dashCooldown<=0 && !player.dashing){
    player.dashing = true;
    player.dashTime = 10;
    player.dashCooldown = 30;
  }
  if(player.dashing){
    player.dx = 15 * player.facing;
    player.dashTime--;
    if(player.dashTime<=0) player.dashing=false;
  }
  if(player.dashCooldown>0) player.dashCooldown--;

  // Attack
  if(keys["j"] && !player.attacking){ player.attacking=true; player.atk=player.atkDuration; }

  // Gravity & movement
  player.dy += 0.6;
  player.x += player.dx;
  player.y += player.dy;

  // Camera
  const cameraX = Math.max(0,player.x - canvas.width/3);

  generateChunks();

  // Collisions
  player.grounded=false;
  groundChunks.forEach(g=>{
    if(player.x+player.w>g.x && player.x<g.x+g.w && player.y+player.h>=g.y && player.y+player.h<=g.y+10){
      player.y=g.y-player.h; player.dy=0; player.grounded=true; player.canDoubleJump=true;
    }
  });
  platforms.forEach(p=>{
    if(player.x+player.w>p.x && player.x<p.x+p.w && player.y+player.h>=p.y && player.y+player.h<=p.y+10){
      player.y=p.y-player.h; player.dy=0; player.grounded=true; player.canDoubleJump=true;
    }
  });

  if(player.attacking && --player.atk<=0) player.attacking=false;

  // Enemies
  enemies.forEach(e=>{
    e.x += e.dx*2;
    if(player.x+player.w>e.x && player.x<e.x+e.w && player.y+player.h>e.y && player.y<e.y+e.h){
      player.health--;
      player.x -= 20*Math.sign(e.dx);
      if(player.health<=0) reset();
    }
    if(player.attacking){
      const atk = {x:player.x+(player.facing===1?player.w:-30), y:player.y+10, w:30, h:30};
      if(atk.x+atk.w>e.x && atk.x<e.x+e.w && atk.y+atk.h>e.y && atk.y<e.y+e.h) e.hp--;
    }
  });

  // Upgrades
  upgrades.forEach((u,i)=>{
    if(player.x+player.w>u.x && player.x<u.x+u.w && player.y+player.h>u.y && player.y<u.y+u.h){
      applyUpgrade(); upgrades.splice(i,1);
    }
  });

  // Cleanup old chunks
  const minChunk = Math.floor(player.x/CHUNK)-2;
  groundChunks = groundChunks.filter(c=>c.x>=minChunk*CHUNK);
  platforms = platforms.filter(p=>p.x>=minChunk*CHUNK);
  enemies = enemies.filter(e=>e.hp>0 && e.x>=minChunk*CHUNK-100);
  upgrades = upgrades.filter(u=>u.x>=minChunk*CHUNK-100);
}

// ===== Draw =====
function draw(){
  ctx.fillStyle="#87ceeb"; ctx.fillRect(0,0,canvas.width,canvas.height);

  const cameraX = Math.max(0,player.x - canvas.width/3);
  ctx.save();
  ctx.translate(-cameraX,0);

  // Ground & Platforms
  groundChunks.forEach(g=>{ ctx.fillStyle="#2ecc71"; ctx.fillRect(g.x,g.y,g.w,g.h); });
  platforms.forEach(p=>{ ctx.fillStyle="#27ae60"; ctx.fillRect(p.x,p.y,p.w,p.h); });

  // Upgrades & Enemies
  upgrades.forEach(u=>{ ctx.fillStyle="#f1c40f"; ctx.fillRect(u.x,u.y,u.w,u.h); });
  enemies.forEach(e=>{ ctx.fillStyle="#2ed573"; ctx.fillRect(e.x,e.y,e.w,e.h); });

  // Player
  ctx.fillStyle="#ff4757"; ctx.fillRect(player.x,player.y,player.w,player.h);
  if(player.attacking) ctx.fillStyle="#ffa502", ctx.fillRect(player.x+(player.facing===1?player.w:-30),player.y+10,30,30);

  ctx.restore();

  // UI
  ctx.fillStyle="#fff"; ctx.font="14px monospace";
  ctx.fillText(`HP ${player.health}/${player.maxHealth}`,20,25);
  ctx.fillText(`Speed ${player.speed.toFixed(1)}`,20,45);
  ctx.fillText(`Jump ${player.jump}`,20,65);
  ctx.fillText(`Atk ${player.atkDuration}`,20,85);
  ctx.fillText(`Dash Cooldown: ${player.dashCooldown}`,20,105);
}

// ===== Reset =====
function reset(){
  player.x=100; player.y=0; player.health=player.maxHealth=5; player.speed=4; player.jump=12; player.atkDuration=10;
  player.canDoubleJump=true; player.dashCooldown=0; player.dashing=false; player.dashTime=0;
  groundChunks=[]; platforms=[]; enemies=[]; upgrades=[];
}

// ===== Loop =====
(function loop(){ update(); draw(); requestAnimationFrame(loop); })();
</script>
</body>
</html>
